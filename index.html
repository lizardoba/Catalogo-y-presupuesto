<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo Dental Pro - Gesti√≥n y Presupuestos</title>
<style>
:root {
  --color-white: #ffffff;
  --color-black: #000000;
  --color-cream-50: #fcfcf9;
  --color-cream-100: #fffdfd;
  --color-gray-200: #f5f5f5;
  --color-gray-300: #a7a9a9;
  --color-slate-500: #626c71;
  --color-teal-500: #21808d;
  --color-teal-600: #1d7480;
  --color-slate-900: #13343b;
  
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-border: rgba(94, 82, 64, 0.2);
  --color-success: #22c55e;
  --color-error: #ef4444;
  
  --font-family-base: "Inter", -apple-system, sans-serif;
  --radius-lg: 12px;
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --space-24: 24px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-background: #1f2121;
    --color-surface: #262828;
    --color-text: #f5f5f5;
    --color-text-secondary: rgba(167, 169, 169, 0.7);
    --color-border: rgba(255, 255, 255, 0.1);
  }
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-family-base); background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }

.header { background: linear-gradient(135deg, var(--color-primary) 0%, #1a6873 100%); color: white; padding: 40px 20px; text-align: center; position: relative; }
.currency-selector { position: absolute; top: 20px; right: 20px; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.2); color: white; border: none; cursor: pointer; }

.container { max-width: 1200px; margin: 0 auto; padding: 32px 20px; }

.tabs { display: flex; gap: 20px; margin-bottom: 32px; border-bottom: 2px solid var(--color-border); overflow-x: auto; }
.tab-btn { padding: 12px 20px; background: none; border: none; cursor: pointer; color: var(--color-text-secondary); font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
.tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }

.tab-content { display: none; }
.tab-content.active { display: block; }

.services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
.service-card { background: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-border); overflow: hidden; transition: transform 0.2s; cursor: pointer; box-shadow: var(--shadow-md); }
.service-card:hover { transform: translateY(-5px); }
.service-card img { width: 100%; height: 180px; object-fit: cover; }
.service-card__content { padding: 20px; }
.service-card__title { font-size: 1.25rem; margin-bottom: 8px; color: var(--color-primary); }
.service-card__price { font-weight: bold; color: var(--color-text); margin-bottom: 15px; }

.btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 14px; }
.btn-primary { background: var(--color-primary); color: white; }
.btn-primary:hover { background: var(--color-primary-hover); }
.btn-secondary { background: var(--color-gray-200); color: var(--color-text); }
.btn-danger { background: var(--color-error); color: white; }
.btn-whatsapp { background: #25D366; color: white; width: 100%; margin-top: 10px; }

/* Modales */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.modal.active { display: flex; }
.modal__content { background: var(--color-surface); padding: 30px; border-radius: 16px; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
.modal__close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; border: none; background: none; color: var(--color-text-secondary); }

.form-group { margin-bottom: 15px; }
.form-label { display: block; margin-bottom: 5px; font-weight: 500; }
.form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-surface); color: var(--color-text); }

/* Tabla de Presupuesto */
.budget-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
.budget-table th, .budget-table td { padding: 12px; border-bottom: 1px solid var(--color-border); text-align: left; }
.total-display { text-align: right; font-size: 1.5rem; font-weight: bold; color: var(--color-primary); margin: 20px 0; }

.subcategory-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--color-gray-200); border-radius: 8px; margin-bottom: 8px; }
.subcategory-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }

@media (max-width: 600px) {
  .header__title { font-size: 1.5rem; }
  .tabs { gap: 10px; }
}
</style>
</head>
<body>

<div class="header">
  <select class="currency-selector" id="currencySelector" onchange="changeCurrency(this.value)">
    <option value="PEN">S/ Soles</option>
    <option value="USD">US$ D√≥lares</option>
    <option value="EUR">‚Ç¨ Euros</option>
  </select>
  <h1 class="header__title">ü¶∑ Cat√°logo Dental Pro</h1>
  <p>Gesti√≥n de Tratamientos y Presupuestos</p>
</div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('view')">üìã Ver Cat√°logo</button>
    <button class="tab-btn" onclick="showTab('manage')">‚öôÔ∏è Gestionar</button>
    <button class="tab-btn" onclick="showTab('budgets')">üßæ Presupuestos</button>
  </div>

  <div id="view" class="tab-content active">
    <div class="services-grid" id="servicesGrid"></div>
  </div>

  <div id="manage" class="tab-content">
    <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openTreatmentModal()">‚ûï Nuevo Tratamiento</button>
    <div class="services-grid" id="manageGrid"></div>
  </div>

  <div id="budgets" class="tab-content">
    <div style="background: var(--color-surface); padding: 25px; border-radius: 12px; box-shadow: var(--shadow-md);">
      <h3>Crear Presupuesto</h3>
      <div class="form-group" style="margin-top:15px;">
        <label class="form-label">Cliente</label>
        <input type="text" id="budgetClient" class="form-input" placeholder="Nombre del paciente">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
        <div class="form-group">
          <label class="form-label">Tratamiento</label>
          <select id="budgetTreatmentSelect" class="form-select" onchange="updateSubcategorySelect()"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Subcategor√≠a</label>
          <select id="budgetSubSelect" class="form-select"></select>
        </div>
        <button class="btn btn-primary" onclick="addToBudget()" style="margin-bottom: 15px;">Agregar</button>
      </div>

      <table class="budget-table">
        <thead>
          <tr><th>√çtem</th><th>Precio</th><th>Acci√≥n</th></tr>
        </thead>
        <tbody id="budgetItems"></tbody>
      </table>
      <div class="total-display">Total: <span id="budgetTotalDisplay">0.00</span></div>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="shareWhatsApp()">üì± Enviar por WhatsApp</button>
        <button class="btn btn-secondary" onclick="clearBudget()">üóëÔ∏è Limpiar</button>
      </div>
    </div>
  </div>
</div>

<div id="treatmentModal" class="modal">
  <div class="modal__content">
    <button class="modal__close" onclick="closeModal()">&times;</button>
    <h2 id="modalTitle">Nuevo Tratamiento</h2>
    <input type="hidden" id="editId">
    
    <div class="form-group">
      <label class="form-label">Nombre</label>
      <input type="text" id="tName" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Descripci√≥n</label>
      <textarea id="tDesc" class="form-textarea"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Precio Base</label>
      <input type="number" id="tPrice" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">URL Imagen</label>
      <input type="text" id="tImage" class="form-input" placeholder="https://...">
    </div>

    <div style="border-top: 1px solid var(--color-border); padding-top: 15px; margin-top: 15px;">
      <h4>Subcategor√≠as</h4>
      <div style="display: grid; grid-template-columns: 1fr 100px auto; gap: 10px; margin: 10px 0;">
        <input type="text" id="subName" class="form-input" placeholder="Nombre">
        <input type="number" id="subPrice" class="form-input" placeholder="Precio">
        <button class="btn btn-secondary" onclick="addSubToTemp()">A√±adir</button>
      </div>
      <div id="tempSubList"></div>
    </div>

    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="btn btn-primary" onclick="saveTreatment()">Guardar Tratamiento</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
// --- CONFIGURACI√ìN Y ESTADO ---
const exchangeRates = { PEN: 1, USD: 0.26, EUR: 0.24 };
const currencySymbols = { PEN: 'S/', USD: 'US$', EUR: '‚Ç¨' };
let currentCurrency = localStorage.getItem('currency') || 'PEN';
let treatments = JSON.parse(localStorage.getItem('treatments')) || [];
let tempSubcategories = [];
let currentBudget = [];

// --- INICIALIZACI√ìN ---
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('currencySelector').value = currentCurrency;
  renderAll();
  updateBudgetSelects();
});

// --- FUNCIONES DE NAVEGACI√ìN ---
function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
  if(tabId === 'budgets') updateBudgetSelects();
}

// --- GESTI√ìN DE MONEDA ---
function changeCurrency(val) {
  currentCurrency = val;
  localStorage.setItem('currency', val);
  renderAll();
  updateBudgetTotal();
}

function formatPrice(amount) {
  const converted = amount * exchangeRates[currentCurrency];
  return `${currencySymbols[currentCurrency]} ${converted.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// --- GESTI√ìN DE TRATAMIENTOS ---
function renderAll() {
  const viewGrid = document.getElementById('servicesGrid');
  const manageGrid = document.getElementById('manageGrid');
  viewGrid.innerHTML = '';
  manageGrid.innerHTML = '';

  treatments.forEach(t => {
    // Render para Cat√°logo
    viewGrid.innerHTML += `
      <div class="service-card">
        <img src="${t.imagen || 'https://via.placeholder.com/300?text=Dental'}" alt="${t.nombre}">
        <div class="service-card__content">
          <div class="service-card__title">${t.nombre}</div>
          <div class="service-card__description">${t.descripcion}</div>
          <div class="service-card__price">Desde ${formatPrice(t.precio)}</div>
        </div>
      </div>
    `;

    // Render para Gesti√≥n
    manageGrid.innerHTML += `
      <div class="service-card" style="cursor: default">
        <div class="service-card__content">
          <div class="service-card__title">${t.nombre}</div>
          <div style="display: flex; gap: 5px;">
            <button class="btn btn-secondary" onclick="openTreatmentModal(${t.id})">Editar</button>
            <button class="btn btn-danger" onclick="deleteTreatment(${t.id})">Eliminar</button>
          </div>
        </div>
      </div>
    `;
  });
}

function openTreatmentModal(id = null) {
  const modal = document.getElementById('treatmentModal');
  const editId = document.getElementById('editId');
  modal.classList.add('active');
  
  if(id) {
    const t = treatments.find(item => item.id === id);
    document.getElementById('modalTitle').innerText = 'Editar Tratamiento';
    editId.value = t.id;
    document.getElementById('tName').value = t.nombre;
    document.getElementById('tDesc').value = t.descripcion;
    document.getElementById('tPrice').value = t.precio;
    document.getElementById('tImage').value = t.imagen;
    tempSubcategories = [...t.subcategorias];
  } else {
    document.getElementById('modalTitle').innerText = 'Nuevo Tratamiento';
    editId.value = '';
    document.getElementById('tName').value = '';
    document.getElementById('tDesc').value = '';
    document.getElementById('tPrice').value = '';
    document.getElementById('tImage').value = '';
    tempSubcategories = [];
  }
  renderTempSubs();
}

function addSubToTemp() {
  const name = document.getElementById('subName').value;
  const price = document.getElementById('subPrice').value;
  if(!name || !price) return alert("Completa nombre y precio de la subcategor√≠a");
  
  tempSubcategories.push({ id: Date.now(), nombre: name, precio: parseFloat(price) });
  document.getElementById('subName').value = '';
  document.getElementById('subPrice').value = '';
  renderTempSubs();
}

function renderTempSubs() {
  const container = document.getElementById('tempSubList');
  container.innerHTML = tempSubcategories.map(s => `
    <div class="subcategory-item">
      <span>${s.nombre} - ${formatPrice(s.precio)}</span>
      <button class="btn btn-danger" style="padding: 2px 8px; margin-left: auto;" onclick="removeTempSub(${s.id})">x</button>
    </div>
  `).join('');
}

function removeTempSub(id) {
  tempSubcategories = tempSubcategories.filter(s => s.id !== id);
  renderTempSubs();
}

function saveTreatment() {
  const id = document.getElementById('editId').value;
  const newT = {
    id: id ? parseInt(id) : Date.now(),
    nombre: document.getElementById('tName').value,
    descripcion: document.getElementById('tDesc').value,
    precio: parseFloat(document.getElementById('tPrice').value) || 0,
    imagen: document.getElementById('tImage').value,
    subcategorias: tempSubcategories
  };

  if(id) {
    treatments = treatments.map(t => t.id === parseInt(id) ? newT : t);
  } else {
    treatments.push(newT);
  }

  localStorage.setItem('treatments', JSON.stringify(treatments));
  closeModal();
  renderAll();
}

function deleteTreatment(id) {
  if(confirm('¬øSeguro que deseas eliminar este tratamiento?')) {
    treatments = treatments.filter(t => t.id !== id);
    localStorage.setItem('treatments', JSON.stringify(treatments));
    renderAll();
  }
}

function closeModal() {
  document.getElementById('treatmentModal').classList.remove('active');
}

// --- L√ìGICA DE PRESUPUESTOS ---
function updateBudgetSelects() {
  const tSelect = document.getElementById('budgetTreatmentSelect');
  tSelect.innerHTML = '<option value="">Seleccione...</option>' + 
    treatments.map(t => `<option value="${t.id}">${t.nombre}</option>`).join('');
  updateSubcategorySelect();
}

function updateSubcategorySelect() {
  const tId = document.getElementById('budgetTreatmentSelect').value;
  const subSelect = document.getElementById('budgetSubSelect');
  if(!tId) {
    subSelect.innerHTML = '<option value="">--</option>';
    return;
  }
  const t = treatments.find(item => item.id == tId);
  subSelect.innerHTML = '<option value="base">Precio Base</option>' + 
    t.subcategorias.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
}

function addToBudget() {
  const tId = document.getElementById('budgetTreatmentSelect').value;
  const sId = document.getElementById('budgetSubSelect').value;
  if(!tId || !sId) return;

  const t = treatments.find(item => item.id == tId);
  let itemName = t.nombre;
  let itemPrice = t.precio;

  if(sId !== 'base') {
    const sub = t.subcategorias.find(s => s.id == sId);
    itemName += ` (${sub.nombre})`;
    itemPrice = sub.precio;
  }

  currentBudget.push({ id: Date.now(), nombre: itemName, precio: itemPrice });
  renderBudgetTable();
}

function renderBudgetTable() {
  const container = document.getElementById('budgetItems');
  container.innerHTML = currentBudget.map(item => `
    <tr>
      <td>${item.nombre}</td>
      <td>${formatPrice(item.precio)}</td>
      <td><button class="btn btn-danger" style="padding: 2px 8px;" onclick="removeFromBudget(${item.id})">x</button></td>
    </tr>
  `).join('');
  updateBudgetTotal();
}

function removeFromBudget(id) {
  currentBudget = currentBudget.filter(i => i.id !== id);
  renderBudgetTable();
}

function updateBudgetTotal() {
  const total = currentBudget.reduce((sum, item) => sum + item.precio, 0);
  document.getElementById('budgetTotalDisplay').innerText = formatPrice(total);
}

function clearBudget() {
  currentBudget = [];
  document.getElementById('budgetClient').value = '';
  renderBudgetTable();
}

function shareWhatsApp() {
  if(currentBudget.length === 0) return alert("Presupuesto vac√≠o");
  
  const client = document.getElementById('budgetClient').value || "Cliente";
  let message = `ü¶∑ *PRESUPUESTO DENTAL*\n\n`;
  message += `Paciente: ${client}\n`;
  message += `--------------------------\n`;
  
  currentBudget.forEach(item => {
    message += `‚Ä¢ ${item.nombre}: ${formatPrice(item.price || item.precio)}\n`;
  });
  
  const total = currentBudget.reduce((sum, i) => sum + (i.price || i.precio), 0);
  message += `\n*TOTAL: ${formatPrice(total)}*\n\n`;
  message += `¬øDesea agendar una cita? üòä`;

  const encoded = encodeURIComponent(message);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
}
</script>

</body>
</html>
